<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="CSS/profile.css">
</head>

<body>

    <!-- NAVIGATION -->
    <nav>
        <ul>
            <li class="logo">âš¡</li>
            <li><a href="index.html">Home</a></li>
            <li><a href="user_dashboard.html">Dashboard</a></li>
            <li><a href="calculator_page.html">Calculator</a></li>
            <li><a href="result.html">Results</a></li>
            <li><a class="active" href="profile_page.html">Profile</a></li>
            <li><a href="#" onclick="handleLogout(); return false;">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>User Profile</h1>

        <form onsubmit="event.preventDefault(); handleProfileUpdate();" class="profile-form">

            <label>Name:</label>
            <input type="text" id="profile_name" placeholder="Your name">

            <label>Email:</label>
            <input type="email" id="profile_email" placeholder="Your email" disabled>

            <label>Phone:</label>
            <input type="tel" id="profile_phone" placeholder="Your phone number">

            <label>Address:</label>
            <input type="text" id="profile_address" placeholder="Your address">

            <button type="submit" class="btn">Update Profile</button>
        </form>

        <p class="info-text"><em>Your information is securely stored using Supabase.</em></p>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const session = await initAuth();
            if (session) loadUserProfile();
        });

        async function loadUserProfile() {
            const user = await getCurrentUser();
            if (!user) return;

            document.getElementById("profile_name").value = user.user_metadata?.full_name || "";
            document.getElementById("profile_email").value = user.email || "";
            document.getElementById("profile_phone").value = user.user_metadata?.phone || "";
            document.getElementById("profile_address").value = user.user_metadata?.address || "";
        }

        async function handleProfileUpdate() {
            const name = document.getElementById("profile_name").value;
            const phone = document.getElementById("profile_phone").value;
            const address = document.getElementById("profile_address").value;

            const user = await getCurrentUser();
            if (!user) {
                alert("You must be logged in to update your profile.");
                return;
            }

            const { error } = await supabaseClient.auth.updateUser({
                data: { full_name: name, phone: phone, address: address }
            });

            if (error) {
                alert("Error updating profile: " + error.message);
            } else {
                alert("Profile updated successfully!");
            }
        }

        async function handleLogout() {
            const success = await signOut();
            if (success) window.location.href = "login.html";
            else alert("Logout failed. Try again.");
        }
    </script>

</body>
</html>
