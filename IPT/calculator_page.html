<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electric Bill Calculator</title>
    <link rel="stylesheet" href="CSS/calculator_page.css">
</head>

<body>

    <!-- NAVIGATION -->
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="user_dashboard.html">Dashboard</a></li>
            <li><a class="active" href="calculator_page.html">Calculator</a></li>
            <li><a href="result.html">Results</a></li>
            <li><a href="profile_page.html">Profile</a></li>
            <li><a href="#" onclick="handleLogout(); return false;">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>Electric Bill Calculator</h1>

        <form onsubmit="event.preventDefault();">
            
            <label for="month">Month:</label>
            <input id="month" type="text" placeholder="e.g., January 2024" required>

            <label for="power_consumption">Power Consumption (kWh):</label>
            <input id="power_consumption" type="number" step="0.01" placeholder="Enter kWh used" required>

            <label for="cost_per_kwh">Cost per kWh (₱):</label>
            <input id="cost_per_kwh" type="number" step="0.01" placeholder="Enter cost per kWh" required>

            <button id="btn_calculate" type="button" class="btn">Calculate</button>
        </form>

        <div id="result" class="result-box"></div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            await initAuth();
        });

        btn_calculate.addEventListener("click", async function () {

            let month = document.getElementById("month");
            let power_consumption = document.getElementById("power_consumption");
            let cost_per_kwh = document.getElementById("cost_per_kwh");
            let result = document.getElementById("result");

            if (!month.value || !power_consumption.value || !cost_per_kwh.value) {
                alert("Please fill in all fields!");
                return;
            }

            const user = await getCurrentUser();
            if (!user) {
                alert("Please log in first.");
                window.location.href = "login.html";
                return;
            }

            let total = parseFloat(power_consumption.value) * parseFloat(cost_per_kwh.value);

            result.innerHTML = `<p class='total-text'>Your electric bill is: <strong>₱ ${total.toFixed(2)}</strong></p>`;

            try {
                await supabaseClient.from("calculations").insert([
                    {
                        user_id: user.id,
                        month: month.value,
                        power_consumption: parseFloat(power_consumption.value),
                        cost_per_kwh: parseFloat(cost_per_kwh.value),
                        result: total,
                    }
                ]);
            } catch (err) {
                alert("Error saving calculation: " + err.message);
            }

            month.value = "";
            power_consumption.value = "";
            cost_per_kwh.value = "";
        });

        async function handleLogout() {
            const success = await signOut();
            if (success) window.location.href = "login.html";
            else alert("Logout failed.");
        }
    </script>

</body>
</html>
